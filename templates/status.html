{% extends "base.html" %}
{% block content %}
<h2>Task Status</h2>

<div class="card p-4 shadow-sm">
  <p><strong>Status:</strong> <span id="status-box">{{ status.status }}</span></p>
  <p><strong>Progress:</strong> <span id="progress-box">{{ status.progress }}</span></p>

  <!-- Bootstrap progress bar -->
  <div class="progress mb-3">
    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
         role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
      0%
    </div>
  </div>

  <div id="files-box">
    {% if status.files.qp %}
      <a href="{{ url_for('download_file', task_id=task_id, file_key='merged_qp') }}" class="btn btn-success m-1">Download Merged QP</a>
    {% endif %}
    {% if status.files.ms %}
      <a href="{{ url_for('download_file', task_id=task_id, file_key='merged_ms') }}" class="btn btn-success m-1">Download Merged MS</a>
    {% endif %}
    {% if status.files.topical %}
      <h5>Topical Files</h5>
      <ul>
        {% for file in status.files.topical %}
          <li>
            <a href="{{ url_for('download_file', task_id=task_id, file_key='topical_' ~ loop.index0) }}">{{ file.topic }}</a>
          </li>
        {% endfor %}
      </ul>
    {% endif %}
  </div>
</div>

<script src="{{ url_for('static', filename='js/script.js') }}"></script>
<script>
  pollTaskStatus("{{ task_id }}");

  // Update progress bar dynamically
  function updateProgressBar(progressText) {
    const bar = document.getElementById("progress-bar");
    const match = progressText.match(/(\d+)%/);
    if (match) {
      const percent = parseInt(match[1]);
      bar.style.width = percent + "%";
      bar.setAttribute("aria-valuenow", percent);
      bar.textContent = percent + "%";
    }
  }

  // Hook into the polling function
  const originalPoll = pollTaskStatus;
  pollTaskStatus = function(taskId) {
    const statusBox = document.getElementById("status-box");
    const progressBox = document.getElementById("progress-box");

    async function fetchStatus() {
      try {
        const response = await fetch(`/status_api/${taskId}`);
        const data = await response.json();

        statusBox.textContent = data.status;
        progressBox.textContent = data.progress;
        updateProgressBar(data.progress);

        // Update file links
        const filesBox = document.getElementById("files-box");
        filesBox.innerHTML = "";
        if (data.files.qp) {
          filesBox.innerHTML += `<a class="btn btn-success m-1" href="/download/${taskId}/merged_qp">Download Merged QP</a>`;
        }
        if (data.files.ms) {
          filesBox.innerHTML += `<a class="btn btn-success m-1" href="/download/${taskId}/merged_ms">Download Merged MS</a>`;
        }
        if (data.files.topical) {
          filesBox.innerHTML += "<h5>Topical Files</h5><ul>";
          data.files.topical.forEach((file, idx) => {
            filesBox.innerHTML += `<li><a href="/download/${taskId}/topical_${idx}">${file.topic}</a></li>`;
          });
          filesBox.innerHTML += "</ul>";
        }

        if (data.status !== "Completed" && data.status !== "Error") {
          setTimeout(fetchStatus, 5000);
        }
      } catch (err) {
        progressBox.textContent = "Error fetching status. Retrying...";
        setTimeout(fetchStatus, 10000);
      }
    }

    fetchStatus();
  };

  // Start polling
  pollTaskStatus("{{ task_id }}");
</script>
{% endblock %}
